<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- スマートフォンでの表示と、拡大縮小の制御 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>決済UI実験モックアップ</title>

    <!-- 1. CSS（すべてのスタイルをここに格納） -->
    <style>
        /* --- 全体・基本スタイル --- */
        :root {
            --primary-color: #007aff; /* メインカラー */
            --bg-color: #f4f4f8;      /* 背景色 */
            --fg-color: #ffffff;      /* カード背景色 */
            --text-color: #1c1c1e;    /* テキスト色 */
            --text-subtle-color: #6a6a6e; /* サブテキスト色 */
            --border-color: #e0e0e0;   /* 境界線 */
            --gauge-bg: #ececec;      /* ゲージ背景 */
            --gauge1-fill: #ff3b30;   /* ゲージ1（赤系） */
            --gauge2-app: #34c759;    /* ゲージ2 アプリ残高（緑系） */
            --gauge2-other: #5ac8fa;  /* ゲージ2 その他資産（青系） */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            overflow: hidden;
            position: relative;
        }

        /* --- 画面制御 --- */
        .screen {
            display: none; /* 基本はすべて非表示 */
            box-sizing: border-box;
            padding: 24px;
            width: 100%;
            height: 100svh;
            position: absolute;
            top: 0;
            left: 0;
            overflow-y: auto;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        .screen.active {
            display: flex; 
        }

        /* --- UIコンポーネント --- */
        .container {
            background-color: var(--fg-color);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        h1, h2, h3 { margin-top: 0; text-align: center; }
        h2 { font-size: 1.5rem; margin-bottom: 24px; }
        p, .label { font-size: 0.9rem; color: var(--text-subtle-color); margin-top: 0; margin-bottom: 8px; }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            margin-bottom: 16px;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        button {
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--fg-color);
            background-color: var(--primary-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }
        button.secondary { background-color: #e5e5ea; color: var(--text-color); margin-top: 12px; }

        .balance-display { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .balance-label { font-size: 1.1rem; font-weight: 500; }
        .balance-amount { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); }
        .balance-amount .currency { font-size: 1rem; font-weight: 400; color: var(--text-subtle-color); margin-left: 4px; }

        /* --- 画面D: QRリーダー --- */
        #qr-reader { position: relative; width: 100%; max-width: 300px; margin: 0 auto 20px auto; border-radius: 16px; overflow: hidden; border: 2px solid var(--border-color); }
        #qr-video { width: 100%; height: auto; display: block; }
        #qr-canvas { display: none; }
        #payment-amount-display { text-align: center; font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; }

        /* --- 画面E: 決済完了・ゲージ --- */
        .payment-result-group { width: 100%; margin-bottom: 24px; }
        .result-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .result-label { font-size: 1rem; font-weight: 500; color: var(--text-subtle-color); }
        .result-amount { font-size: 1.2rem; font-weight: 600; }

        /* ゲージの基本スタイル */
        .gauge-container {
            width: 100%;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            
            /* (★ z-index案) 容器（背景色） */
            background-color: var(--gauge-bg);
            z-index: 2; /* 2. 容器（背景） */
        }

        /* ゲージ1: 局所ゲージ */
        #gauge1-fill {
            height: 100%;
            width: 100%; /* 初期値 */
            background-color: var(--gauge1-fill);
            border-radius: 12px 0 0 12px;
        }

        /* ゲージ2: ビューポート */
        #gauge2-viewport {
            /* ゲージコンテナのスタイルを継承 */
        }
        
        /* (★ z-index案) ゲージ2のレイヤー（手前/奥） */
        .gauge-layer {
            position: absolute;
            top: 0;
            height: 100%;
            border-radius: 12px 0 0 12px;
        }

        /* レイヤー（手前）: アプリ残高 (z-index: 3) */
        #gauge2-app-layer {
            z-index: 3; /* 1. アプリ残高 (手前) */
            width: 100%; /* 初期値 (JSで制御) */
            right: 0; /* ★ 圧縮・結合のため「右寄せ」 */
        }
        #gauge2-app-fill {
            height: 100%;
            width: 100%; /* 初期値 (JSで制御) */
            background-color: var(--gauge2-app);
            border-radius: 12px 0 0 12px;
        }
        
        /* レイヤー（奥）: 総資産 (z-index: 1) */
        #gauge2-total-layer {
            z-index: 1; /* 3. 総資産 (奥) */
            width: 0%; /* 初期値 (JSで制御) */
            left: 0; /* ★ 結合のため「左寄せ」 */
            display: flex; /* 中の要素を並べる */
        }
        #gauge2-other-assets {
            height: 100%;
            width: 100%; /* JSで(otherAssetsPercentOfTotal)が設定される */
            background-color: var(--gauge2-other);
            border-radius: 12px 0 0 12px;
        }
        
        /* 支払い金額（赤色） */
        #display-payment-amount {
            color: var(--gauge1-fill);
            font-weight: 700;
        }

    </style>
</head>
<body>

    <!-- 2. HTML（すべての画面をここに格納） -->

    <!-- (画面A〜Dは変更なし) ... -->
    <!-- 画面A： 初期設定 -->
    <div id="screenA" class="screen active">
        <div class="container">
            <h2>初期設定</h2>
            <label for="input-total-assets" class="label">1. 総資産額（銀行預金など）</label>
            <input type="number" id="input-total-assets" placeholder="例: 1000000">
            
            <label for="input-app-balance" class="label">2. アプリへの初期チャージ額</label>
            <input type="number" id="input-app-balance" placeholder="例: 50000">
            
            <button id="btn-setup-complete">設定完了</button>
        </div>
        <p>※仮想の金額を入力してください</p>
    </div>

    <!-- 画面B： 待機（ホーム） -->
    <div id="screenB" class="screen">
        <div class="container">
            <h2>ホーム</h2>
            <div class="balance-display">
                <span class="balance-label">総資産</span>
                <span class="balance-amount"><span id="display-total-assets">0</span><span class="currency">円</span></span>
            </div>
            <div class="balance-display">
                <span class="balance-label">アプリ残高</span>
                <span class="balance-amount" style="color: var(--gauge2-app);"><span id="display-app-balance">0</span><span class="currency">円</span></span>
            </div>
        </div>
        <div class="container">
            <button id="btn-goto-payment">支払い（QRスキャン）</button>
            <button id="btn-goto-charge" class="secondary">チャージ</button>
        </div>
    </div>

    <!-- 画面C： チャージ -->
    <div id="screenC" class="screen">
        <div class="container">
            <h2>チャージ</h2>
            <label for="input-charge-amount" class="label">チャージ金額</label>
            <input type="number" id="input-charge-amount" placeholder="チャージする金額">
            
            <button id="btn-execute-charge">チャージ実行</button>
            <button id="btn-back-to-home-from-C" class="secondary">戻る</button>
        </div>
    </div>

    <!-- 画面D： 支払い -->
    <div id="screenD" class="screen">
        <div class="container">
            <h2>支払い</h2>
            <p>QRコードをスキャンしてください</p>
            <div id="qr-reader">
                <video id="qr-video" playsinline></video>
                <canvas id="qr-canvas"></canvas>
            </div>
            
            <label for="input-payment-amount" class="label">支払金額</label>
            <input type="number" id="input-payment-amount" placeholder="金額（QRスキャンで自動入力）">
            
            <button id="btn-execute-payment">支払いを実行</button>
            <button id="btn-back-to-home-from-D" class="secondary">戻る</button>
        </div>
    </div>

    <!-- 画面E： 決済完了 -->
    <div id="screenE" class="screen">
        <div class="container">
            <h2>支払い完了</h2>
            
            <!-- 支払金額 -->
            <div class="payment-result-group">
                <div class="result-header">
                    <span class="result-label">支払金額</span>
                    <span class="result-amount" id="display-payment-amount">- 0円</span>
                </div>
            </div>

            <!-- アプリ内残高（局所） -->
            <div class="payment-result-group">
                <div class="result-header">
                    <span class="result-label">アプリ内残高</span>
                    <span class="result-amount" id="display-app-balance-after">0円</span>
                </div>
                <!-- ゲージ1（局所・停止用） -->
                <div id="gauge1" class="gauge-container">
                    <div id="gauge1-fill"></div>
                </div>
            </div>
            
            <!-- 総資産（全体） -->
            <div class="payment-result-group">
                <div class="result-header">
                    <span class="result-label">総資産</span>
                    <span class="result-amount" id="display-total-assets-after">0円</span>
                </div>
                
                <!-- (★ z-index案) ゲージ2（容器） -->
                <div id="gauge2-viewport" class="gauge-container">
                    
                    <!-- (★ z-index案) レイヤー（奥）: 総資産 -->
                    <div id="gauge2-total-layer" class="gauge-layer">
                        <div id="gauge2-other-assets"></div>
                        <!-- アプリ残高（最終状態）は、ここでは描画しない（背景色が見える） -->
                    </div>
                    
                    <!-- (★ z-index案) レイヤー（手前）: アプリ残高 -->
                    <div id="gauge2-app-layer" class="gauge-layer">
                        <div id="gauge2-app-fill"></div>
                    </div>
                    
                </div>
            </div>
            
            <button id="btn-return-to-home" class="secondary">ホームへ戻る</button>
        </div>
    </div>


    <!-- 3. JavaScript ライブラリ -->
    <!-- jsQR (QRコード読み取り用) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>


    <!-- 4. JavaScript（すべてのロジックをここに格納） -->
    <script>
        
        /* --- 2. データ管理 --- */
        let experimentState = {
          totalAssets: 0, appBalance: 0, paymentAmount: 0,
          totalAssetsBeforePayment: 0, appBalanceBeforePayment: 0
        };
        let videoStream = null;
        let animationFrameId = null;

        /* --- 3. 画面管理 --- */
        const allScreens = document.querySelectorAll('.screen');
        
        function showScreen(screenId) {
            if (videoStream) { stopQRScanner(); }
            allScreens.forEach(screen => { screen.classList.remove('active'); });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                if (screenId === 'screenB') { updateHomeScreen(); }
                else if (screenId === 'screenD') {
                    document.getElementById('input-payment-amount').value = '';
                    startQRScanner();
                } else if (screenId === 'screenE') {
                    runPaymentAnimation();
                }
            }
        }
        
        function formatCurrency(value) {
            const num = Math.round(value);
            return new Intl.NumberFormat('ja-JP').format(num);
        }

        /* --- 4. 各画面の詳細仕様（イベントリスナー） --- */
        
        document.addEventListener('DOMContentLoaded', () => {

            /* --- 4.1. 画面A： 初期設定 --- */
            document.getElementById('btn-setup-complete').addEventListener('click', () => {
                const totalAssets = parseFloat(document.getElementById('input-total-assets').value);
                const appBalance = parseFloat(document.getElementById('input-app-balance').value);
                if (isNaN(totalAssets) || isNaN(appBalance) || totalAssets <= 0 || appBalance <= 0) {
                    alert("有効な金額を入力してください。"); return;
                }
                if (totalAssets < appBalance) {
                    alert("総資産額は、アプリへのチャージ額以上である必要があります。"); return;
                }
                experimentState.totalAssets = totalAssets;
                experimentState.appBalance = appBalance;
                showScreen('screenB');
            });

            /* --- 4.2. 画面B： 待機（ホーム） --- */
            document.getElementById('btn-goto-charge').addEventListener('click', () => { showScreen('screenC'); });
            document.getElementById('btn-goto-payment').addEventListener('click', () => { showScreen('screenD'); });
            
            /* --- 4.3. 画面C： チャージ --- */
            document.getElementById('btn-execute-charge').addEventListener('click', () => {
                const chargeAmount = parseFloat(document.getElementById('input-charge-amount').value);
                if (isNaN(chargeAmount) || chargeAmount <= 0) {
                    alert("有効なチャージ金額を入力してください。"); return;
                }
                const availableToCharge = experimentState.totalAssets - experimentState.appBalance;
                if (chargeAmount > availableToCharge) {
                    alert(`チャージ可能な上限額（${formatCurrency(availableToCharge)}円）を超えています。`); return;
                }
                experimentState.appBalance += chargeAmount;
                document.getElementById('input-charge-amount').value = '';
                showScreen('screenB');
            });
            document.getElementById('btn-back-to-home-from-C').addEventListener('click', () => {
                document.getElementById('input-charge-amount').value = '';
                showScreen('screenB');
            });

            /* --- 4.4. 画面D： 支払い --- */
            document.getElementById('btn-execute-payment').addEventListener('click', () => {
                const paymentAmount = parseFloat(document.getElementById('input-payment-amount').value);
                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert("有効な支払金額を入力してください。"); return;
                }
                if (paymentAmount > experimentState.appBalance) {
                    alert(`アプリ残高（${formatCurrency(experimentState.appBalance)}円）を超えています。`); return;
                }
                experimentState.paymentAmount = paymentAmount;
                experimentState.totalAssetsBeforePayment = experimentState.totalAssets;
                experimentState.appBalanceBeforePayment = experimentState.appBalance;
                experimentState.totalAssets -= paymentAmount;
                experimentState.appBalance -= paymentAmount;
                showScreen('screenE');
            });
            document.getElementById('btn-back-to-home-from-D').addEventListener('click', () => { showScreen('screenB'); });
            
            /* --- 4.5. 画面E： 決済完了 --- */
            document.getElementById('btn-return-to-home').addEventListener('click', () => { showScreen('screenB'); });
        });

        /* --- 画面B: ホーム画面の更新ロジック --- */
        function updateHomeScreen() {
            document.getElementById('display-total-assets').textContent = formatCurrency(experimentState.totalAssets);
            document.getElementById('display-app-balance').textContent = formatCurrency(experimentState.appBalance);
        }

        /* --- 画面D: QRスキャナーのロジック --- */
        const video = document.getElementById('qr-video');
        const canvasElement = document.getElementById('qr-canvas');
        const canvas = canvasElement.getContext('2d', { willReadFrequently: true });
        async function startQRScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                await video.play();
                animationFrameId = requestAnimationFrame(tick);
            } catch (err) {
                console.error("QRスキャナーの起動に失敗しました:", err);
                alert("カメラの起動に失敗しました。ブラウザのカメラ権限を確認してください。");
            }
        }
        function stopQRScanner() {
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; video.srcObject = null; }
        }
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert", });
                if (code) {
                    const paymentAmount = parseFloat(code.data);
                    if (!isNaN(paymentAmount) && paymentAmount > 0) {
                        document.getElementById('input-payment-amount').value = paymentAmount;
                        stopQRScanner();
                        document.getElementById('input-payment-amount').focus();
                        return;
                    }
                }
            }
            animationFrameId = requestAnimationFrame(tick);
        }

        /* --- 4.5. 画面E: 決済完了アニメーション --- */
        
        // (★ z-index案) アニメーション用のDOM要素をキャッシュ
        const gauge1Fill = document.getElementById('gauge1-fill');
        
        // レイヤー（手前）: アプリ残高
        const gauge2AppLayer = document.getElementById('gauge2-app-layer');
        const gauge2AppFill = document.getElementById('gauge2-app-fill');

        // レイヤー（奥）: 総資産
        const gauge2TotalLayer = document.getElementById('gauge2-total-layer');
        const gauge2OtherAssets = document.getElementById('gauge2-other-assets');


        // (★ z-index案) runPaymentAnimation 関数
        function runPaymentAnimation() {
            // 1. データを読み込み
            const {
                paymentAmount,
                appBalanceBeforePayment,
                totalAssetsBeforePayment
            } = experimentState;

            // 2. 数字情報を即座に表示（丸め誤差を考慮）
            const preciseAppBalance = appBalanceBeforePayment - paymentAmount;
            const preciseTotalAssets = totalAssetsBeforePayment - paymentAmount;

            document.getElementById('display-payment-amount').textContent = `- ${formatCurrency(paymentAmount)}円`;
            document.getElementById('display-app-balance-after').textContent = `${formatCurrency(preciseAppBalance)}円`;
            document.getElementById('display-total-assets-after').textContent = `${formatCurrency(preciseTotalAssets)}円`;

            // 3. アニメーション計算
            
            // ステップ1: 局所ゲージの減少後の幅（割合）
            const gauge1FillPercent = appBalanceBeforePayment > 0 ? (preciseAppBalance / appBalanceBeforePayment) * 100 : 0;

            // ステップ2/3: 最終状態（総資産）の各領域の幅（割合）
            const preciseAppBalancePercentOfTotal = totalAssetsBeforePayment > 0 ? (preciseAppBalance / totalAssetsBeforePayment) * 100 : 0;
            const otherAssetsPercentOfTotal = 100 - preciseAppBalancePercentOfTotal;

            
            // 4. アニメーション初期設定 (State 0)
            
            // アニメーション（transition）を一時的に無効化
            gauge1Fill.style.transition = 'none';
            gauge2AppLayer.style.transition = 'none';
            gauge2AppFill.style.transition = 'none';
            gauge2TotalLayer.style.transition = 'none';
            
            // ゲージ1を100%に
            gauge1Fill.style.width = '100%';
            
            // レイヤー（手前）: アプリ残高ゲージを100%に
            gauge2AppLayer.style.width = '100%';
            gauge2AppFill.style.width = '100%';
            
            // レイヤー（奥）: 総資産ゲージを0%に（隠す）
            // (★ 修正: total-layer ではなく、other-assets の幅を設定)
            gauge2TotalLayer.style.width = '100%'; // コンテナは100%
            gauge2OtherAssets.style.width = '0%'; // 中身の「その他資産」を0%に
            
            
            // 5. アニメーション実行 (あなたの「圧縮・結合」ステップ)
            
            // 50msの遅延を与え、ブラウザが State 0 を確実に描画するのを待つ
            setTimeout(() => {
                
                // ステップ1:【同期減少】
                gauge1Fill.style.transition = 'width 0.8s ease-out';
                gauge2AppFill.style.transition = 'width 0.8s ease-out';
                
                // ★ 修正: transition の設定をブラウザに描画させるため、
                // 　　s わずかな遅延(次のフレーム)を挟む
                setTimeout(() => {
                    gauge1Fill.style.width = `${gauge1FillPercent}%`;
                    // ★ 修正: 下記の変数名のタイポを修正
                    // (誤) gaugeFille1Percent -> (正) gauge1FillPercent
                    gauge2AppFill.style.width = `${gauge1FillPercent}%`; // 100% -> 80%
                }, 0); // 0msの遅延（次の描画フレーム）

                // (この 0.8秒間、隙間からは「容器」の背景色 --gauge-bg が見える)

                // ステップ2 & 3:【圧縮・結合】（減少アニメーションの完了を待つ）
                setTimeout(() => {
                    // アニメーション（transition）を設定
                    // アプリ残高は「幅」が 0.4s かけて縮小
                    // 総資産は「幅」が 0.4s かけて増加
                    gauge2AppLayer.style.transition = 'width 0.4s ease-in-out';
                    // (★ 修正: total-layer ではなく、other-assets の幅をアニメーション)
                    gauge2OtherAssets.style.transition = 'width 0.4s ease-in-out';
                    
                    // ★ 修正: こちらも同様に、次の描画フレームを待つ
                    setTimeout(() => {
                        // ステップ2:「アプリ残高」を右端で圧縮（幅を最終割合に変更）
                        gauge2AppLayer.style.width = `${preciseAppBalancePercentOfTotal}%`;
                        
                        // ステップ3:「総資産」を左側から出現（幅を最終割合に変更）
                        gauge2OtherAssets.style.width = `${otherAssetsPercentOfTotal}%`;
                    }, 0); // 0msの遅延（次の描画フレーム）
                    
                    // (この 0.4秒間、両者が同時にアニメーションし「結合」する)
                    
                }, 800); // 同期減少アニメーションの時間 (0.8s = 800ms)
            }, 50); // 50msの遅延（State 0 の描画保証のため）
        }
    </script>

</body>
</html>
